/**
 * @license RequireJS domReady 2.0.1 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/domReady for details
 */

/**
 * Phonegap Web Intent plugin
 * Copyright (c) Boris Smus 2010
 *
 */

// Cross-platform sound pool.  Heavily hacked from the MIT licensed code in
// https://github.com/gladiusjs/gladius-core/blob/develop/src/sound/default.js

define("domReady",[],function(){function u(e){var t;for(t=0;t<e.length;t+=1)e[t](s)}function a(){var e=o;i&&e.length&&(o=[],u(e))}function f(){i||(i=!0,n&&clearInterval(n),a())}function c(e){return i?e(s):o.push(e),c}var e,t,n,r=typeof window!="undefined"&&window.document,i=!r,s=r?document:null,o=[];if(r){if(document.addEventListener)document.addEventListener("DOMContentLoaded",f,!1),window.addEventListener("load",f,!1);else if(window.attachEvent){window.attachEvent("onload",f),t=document.createElement("div");try{e=window.frameElement===null}catch(l){}t.doScroll&&e&&window.external&&(n=setInterval(function(){try{t.doScroll(),f()}catch(e){}},30))}document.readyState==="complete"&&f()}return c.version="2.0.1",c.load=function(e,t,n,r){r.isBuild?n(null):c(n)},c}),define("alea",[],function(){function e(){var e=4022871197,t=function(t){t=t.toString();for(var r=0;r<t.length;r++){e+=t.charCodeAt(r);var i=.02519603282416938*e;e=i>>>0,i-=e,i*=e,e=i>>>0,i-=e,e+=i*4294967296}return(e>>>0)*2.3283064365386963e-10};return t.version="Mash 0.9",t}function t(){return function(t){var n=0,r=0,i=0,s=1;t.length==0&&(t=[+(new Date)]);var o=e();n=o(" "),r=o(" "),i=o(" ");for(var u=0;u<t.length;u++)n-=o(t[u]),n<0&&(n+=1),r-=o(t[u]),r<0&&(r+=1),i-=o(t[u]),i<0&&(i+=1);o=null;var a=function(){var e=2091639*n+s*2.3283064365386963e-10;return n=r,r=i,i=e-(s=e|0)};a.uint32=function(){return a()*4294967296},a.fract53=function(){return a()+(a()*2097152|0)*1.1102230246251565e-16},a.choice=function(e){var t=Math.floor(a()*e.length);return e[t]};var f=function(){return a()-.5};return a.shuffle=function(e){e.sort(f)},a.version="Alea 0.9",a.args=t,a}(Array.prototype.slice.call(arguments))}return{Random:t}}),define("compat",[],function(){Function.prototype.bind||(Function.prototype.bind=function(e){var t=Array.prototype.slice.call(arguments,1),n=this,r=function(){},i=function(){return n.apply(this instanceof r?this:e||window,t.concat(Array.prototype.slice.call(arguments)))};return r.prototype=this.prototype,i.prototype=new r,i}),Object.freeze||(Object.freeze=function(e){return e});var e=function(){console.warn("Faking Web Worker creation.")};e.prototype={postMessage:function(e){},addEventListener:function(e,t){}};var t={Worker:typeof Worker=="undefined"?e:Worker,Uint8Array:typeof Uint8Array=="undefined"?Array:Uint8Array,Float64Array:typeof Float64Array=="undefined"?Array:Float64Array};return typeof window!="undefined"&&function(){var e=0,n=["ms","moz","webkit","o"],r;for(r=0;r<n.length&&!window.requestAnimationFrame;++r)window.requestAnimationFrame=window[n[r]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[n[r]+"CancelAnimationFrame"]||window[n[r]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(console.log("Using requestAnimationFrame fallback."),window.requestAnimationFrame=function(t,n){var r=(new Date).getTime(),i=Math.max(0,16-(r-e)),s=window.setTimeout(function(){t(r+i)},i);return e=r+i,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)}),t.requestAnimationFrame=window.requestAnimationFrame.bind(window),t.cancelAnimationFrame=window.cancelAnimationFrame.bind(window)}(),t}),define("webintent",[],function(){var e=window.Cordova||{addConstructor:function(){}},t=function(){};return t.ACTION_SEND="android.intent.action.SEND",t.ACTION_VIEW="android.intent.action.VIEW",t.EXTRA_TEXT="android.intent.extra.TEXT",t.EXTRA_SUBJECT="android.intent.extra.SUBJECT",t.EXTRA_STREAM="android.intent.extra.STREAM",t.EXTRA_EMAIL="android.intent.extra.EMAIL",t.prototype.startActivity=function(t,n,r){return e.exec(function(e){n(e)},function(e){r(e)},"WebIntent","startActivity",[t])},t.prototype.sendBroadcast=function(t,n,r){return e.exec(function(e){n(e)},function(e){r(e)},"WebIntent","sendBroadcast",[t])},t.prototype.hasExtra=function(t,n,r){return e.exec(function(e){n(e)},function(e){r(e)},"WebIntent","hasExtra",[t])},t.prototype.getUri=function(t,n){return e.exec(function(e){t(e)},function(e){n(e)},"WebIntent","getUri",[])},t.prototype.getExtra=function(t,n,r){return e.exec(function(e){n(e)},function(e){r(e)},"WebIntent","getExtra",[t])},t.prototype.onNewIntent=function(t){return e.exec(function(e){t(e)},function(e){},"WebIntent","onNewIntent",[])},e.addConstructor(function(){e.addPlugin("webintent",new t)}),t}),define("funf",["./webintent"],function(e){var t="edu.mit.media.funf.RECORD",n="edu.mit.media.funf.ARCHIVE",r="mainPipeline",i=function(e){console.assert(e.indexOf("-")<0,"funf doesn't like hyphens in the appName"),this.appName=e};return i.prototype={},i.prototype.record=function(e,n){typeof n=="object"&&(n=JSON.stringify(n)),console.log("CSA FUNF "+e+" / "+n);try{var i=document.createEvent("CustomEvent"),s={name:e,value:n,millis:Date.now()},o={action:t,method:"sendBroadcast",extras:{DATABASE_NAME:r,TIMESTAMP:Math.floor(Date.now()/1e3),NAME:this.appName,VALUE:JSON.stringify(s)}};i.initCustomEvent("intent-addon",!0,!0,o),document.documentElement.dispatchEvent(i)}catch(u){console.log("Sending custom event failed: "+u)}},i.prototype.archive=function(){try{var e=document.createEvent("CustomEvent"),t={action:n,method:"sendBroadcast",extras:{DATABASE_NAME:r}};e.initCustomEvent("intent-addon",!0,!0,t),document.documentElement.dispatchEvent(e)}catch(i){console.log("Sending custom event failed: "+i)}},window&&window.Cordova&&window.Cordova.exec&&window.device&&window.device.platform==="Android"&&(i.prototype.record=function(n,i){typeof i=="object"&&(i=JSON.stringify(i));var s=new e,o={name:n,value:i,millis:Date.now()};s.sendBroadcast({action:t,extras:{DATABASE_NAME:r,TIMESTAMP:Math.floor(Date.now()/1e3),NAME:this.appName,VALUE:JSON.stringify(o)}},function(e){},function(e){console.error("Funf logging failed.")})},i.prototype.archive=function(){(new e).sendBroadcast({action:n,extras:{DATABASE_NAME:r}},function(){},function(){})}),i}),define("lawnchair/core",[],function(){var e=function(t,n){if(!(this instanceof e))return new e(t,n);if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(!(arguments.length<=2&&arguments.length>0))throw"Incorrect # of ctor args!";n=typeof arguments[0]=="function"?arguments[0]:arguments[1],t=typeof arguments[0]=="function"?{}:arguments[0];if(typeof n!="function")throw"No callback was provided";this.record=t.record||"record",this.name=t.name||"records";var r;if(t.adapter){for(var i=0,s=e.adapters.length;i<s;i++)if(e.adapters[i].adapter===t.adapter){r=e.adapters[i].valid()?e.adapters[i]:undefined;break}}else for(var i=0,s=e.adapters.length;i<s;i++){r=e.adapters[i].valid()?e.adapters[i]:undefined;if(r)break}if(!r)throw"No valid adapter.";for(var o in r)this[o]=r[o];for(var i=0,s=e.plugins.length;i<s;i++)e.plugins[i].call(this);this.init(t,n)};return e.adapters=[],e.adapter=function(t,n){n.adapter=t;var r="adapter valid init keys save batch get exists all remove nuke".split(" "),i=this.prototype.indexOf;for(var s in n)if(i(r,s)===-1)throw"Invalid adapter! Nonstandard method: "+s;e.adapters.splice(0,0,n)},e.plugins=[],e.plugin=function(t){for(var n in t)n==="init"?e.plugins.push(t[n]):this.prototype[n]=t[n]},e.prototype={isArray:Array.isArray||function(e){return Object.prototype.toString.call(e)==="[object Array]"},indexOf:function(e,t,n,r){if(e.indexOf)return e.indexOf(t);for(n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},lambda:function(e){return this.fn(this.record,e)},fn:function(e,t){return typeof t=="string"?new Function(e,t):t},uuid:function(){var e=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},each:function(e){var t=this.lambda(e);if(this.__results)for(var n=0,r=this.__results.length;n<r;n++)t.call(this,this.__results[n],n);else this.all(function(e){for(var n=0,r=e.length;n<r;n++)t.call(this,e[n],n)});return this}},e}),define("lawnchair/adapters/indexed-db.js",[],function(){return function(e){e.adapter("indexed-db",function(){function e(e,t){console.error("error in indexed-db adapter!",e,t)}var t="lawnchair",n=2,r=function(){return window.indexedDB||window.webkitIndexedDB||window.oIndexedDB||window.msIndexedDB},i=function(){return window.IDBTransaction||window.webkitIDBTransaction||window.mozIDBTransaction||window.oIDBTransaction||window.msIDBTransaction},s=function(){return window.IDBKeyRange||window.webkitIDBKeyRange||window.mozIDBKeyRange||window.oIDBKeyRange||window.msIDBKeyRange},o=function(){return window.IDBDatabaseException||window.webkitIDBDatabaseException||window.mozIDBDatabaseException||window.oIDBDatabaseException||window.msIDBDatabaseException},u=i()&&"READ_WRITE"in i()?i().READ_WRITE:"readwrite";return{valid:function(){return!!r()},init:function(i,s){this.idb=r(),this.waiting=[];var u=this.idb.open(this.name,n),a=this,f=a.fn(a.name,s),l=function(){return u.onupgradeneeded=u.onsuccess=u.error=null,f.call(a,a)},c=function(e,n){try{a.db.deleteObjectStore("teststore")}catch(r){}try{a.db.deleteObjectStore(t)}catch(i){}a.db.createObjectStore(t),a.store=!0};u.onupgradeneeded=function(e){a.db=u.result,a.transaction=u.transaction,c(e.oldVersion,e.newVersion)},u.onsuccess=function(t){a.db=u.result;if(a.db.version!=""+n){var r=a.db.version,i=a.db.setVersion(""+n);i.onsuccess=function(e){var t=i.result;i.onsuccess=i.onerror=null,c(r,n),t.oncomplete=function(){for(var e=0;e<a.waiting.length;e++)a.waiting[e].call(a);a.waiting=[],l()}},i.onerror=function(t){i.onsuccess=i.onerror=null,console.log("Failed to create objectstore "+t),e(t)}}else{a.store=!0;for(var s=0;s<a.waiting.length;s++)a.waiting[s].call(a);a.waiting=[],l()}},u.onblocked=function(e){console.log("onblocked!")},u.onerror=function(e){if(u.errorCode===o().VERSION_ERR)return a.idb.deleteDatabase(a.name),a.init(i,s);console.error("Failed to open database")}},save:function(n,r){if(!this.store){this.waiting.push(function(){this.save(n,r)});return}var i=this,s,o=function(e){s.onsuccess=s.onerror=null,r&&(n.key=e.target.result,i.lambda(r).call(i,n))},a=this.db.transaction(t,u),f=a.objectStore(t);return s=n.key?f.put(n,n.key):f.put(n),s.onsuccess=o,s.onerror=e,this},batch:function(e,t){var n=[],r=!1,i=this,s=function(t){n.push(t),r=n.length===e.length},o=setInterval(function(){r&&(t&&i.lambda(t).call(i,n),clearInterval(o))},200);for(var u=0,a=e.length;u<a;u++)this.save(e[u],s);return this},get:function(n,r){if(!this.store){this.waiting.push(function(){this.get(n,r)});return}var i=this,s=function(e){r&&i.lambda(r).call(i,e.target.result)};if(!this.isArray(n)){var o=this.db.transaction(t).objectStore(t).get(n);o.onsuccess=function(e){o.onsuccess=o.onerror=null,s(e)},o.onerror=function(t){console.log("Failed to find "+n),o.onsuccess=o.onerror=null,e(t)}}else{var u=[],a=!1,f=n,l=function(e){u.push(e),a=u.length===f.length,a&&i.lambda(r).call(i,u)};for(var c=0,h=f.length;c<h;c++)this.get(f[c],l)}return this},exists:function(n,r){if(!this.store){this.waiting.push(function(){this.exists(n,r)});return}var i=this,o=this.db.transaction(t).objectStore(t).openCursor(s().only(n));return o.onsuccess=function(e){o.onsuccess=o.onerror=null;var t;i.lambda(r).call(i,e.target.result!==null&&e.target.result!==t)},o.onerror=function(t){o.onsuccess=o.onerror=null,console.log("Failed to test for "+n),e(t)},this},all:function(e){if(!this.store){this.waiting.push(function(){this.all(e)});return}var n=this.fn(this.name,e)||undefined,r=this,i=this.db.transaction(t).objectStore(t),s=[];return i.openCursor().onsuccess=function(e){var t=e.target.result;t?(s.push(t.value),t["continue"]()):n&&n.call(r,s)},this},remove:function(n,r){if(!this.store){this.waiting.push(function(){this.remove(n,r)});return}typeof n=="object"&&(n=n.key);var i=this,s,o=function(){s.onsuccess=s.onerror=null,r&&i.lambda(r).call(i)};return s=this.db.transaction(t,u).objectStore(t)["delete"](n),s.onsuccess=o,s.onerror=e,this},nuke:function(n,r){if(!this.store){this.waiting.push(function(){this.nuke(n,r)});return}var i=this,s=n?function(){i.lambda(n).call(i)}:function(){};if(r){this.waiting.length&&e(),this.idb.deleteDatabase(this.name),delete this.store,delete this.waiting,s();return}try{this.db.transaction(t,u).objectStore(t).clear().onsuccess=s}catch(o){e()}return this}}}())}}),define("lawnchair/adapters/dom.js",[],function(){return function(e){e.adapter("dom",function(){var e=window.localStorage,t=function(t){return{key:t+"._index_",all:function(){var t=e.getItem(this.key);return t&&(t=JSON.parse(t)),t===null&&e.setItem(this.key,JSON.stringify([])),JSON.parse(e.getItem(this.key))},add:function(t){var n=this.all();n.push(t),e.setItem(this.key,JSON.stringify(n))},del:function(t){var n=this.all(),r=[];for(var i=0,s=n.length;i<s;i++)n[i]!=t&&r.push(n[i]);e.setItem(this.key,JSON.stringify(r))},find:function(e){var t=this.all();for(var n=0,r=t.length;n<r;n++)if(e===t[n])return n;return!1}}};return{valid:function(){return!!e},init:function(e,n){this.indexer=t(this.name),n&&this.fn(this.name,n).call(this,this)},save:function(t,n){var r=t.key?this.name+"."+t.key:this.name+"."+this.uuid();return this.indexer.find(r)===!1&&this.indexer.add(r),delete t.key,e.setItem(r,JSON.stringify(t)),t.key=r.slice(this.name.length+1),n&&this.lambda(n).call(this,t),this},batch:function(e,t){var n=[];for(var r=0,i=e.length;r<i;r++)this.save(e[r],function(e){n.push(e)});return t&&this.lambda(t).call(this,n),this},keys:function(e){if(e){var t=this.name,n=this.indexer.all().map(function(e){return e.replace(t+".","")});this.fn("keys",e).call(this,n)}return this},get:function(t,n){if(this.isArray(t)){var r=[];for(var i=0,s=t.length;i<s;i++){var o=this.name+"."+t[i],u=e.getItem(o);u&&(u=JSON.parse(u),u.key=t[i],r.push(u))}n&&this.lambda(n).call(this,r)}else{var o=this.name+"."+t,u=e.getItem(o);u&&(u=JSON.parse(u),u.key=t),n&&this.lambda(n).call(this,u)}return this},exists:function(e,t){var n=this.indexer.find(this.name+"."+e)===!1?!1:!0;return this.lambda(t).call(this,n),this},all:function(t){var n=this.indexer.all(),r=[],i,s;for(var o=0,u=n.length;o<u;o++)s=n[o],i=JSON.parse(e.getItem(s)),i.key=s.replace(this.name+".",""),r.push(i);return t&&this.fn(this.name,t).call(this,r),this},remove:function(t,n){var r=this.name+"."+(t.key?t.key:t);return this.indexer.del(r),e.removeItem(r),n&&this.lambda(n).call(this),this},nuke:function(e){return this.all(function(t){for(var n=0,r=t.length;n<r;n++)this.remove(t[n]);e&&this.lambda(e).call(this)}),this}}}())}}),define("lawnchair/adapters/window-name.js",[],function(){return function(e){e.adapter("window-name",function(e,t){typeof window=="undefined"&&(window={top:{}});var n=window.top.name?JSON.parse(window.top.name):{};return{valid:function(){return typeof window.top.name!="undefined"},init:function(r,i){n[this.name]=n[this.name]||{index:[],store:{}},e=n[this.name].index,t=n[this.name].store,this.fn(this.name,i).call(this,this)},keys:function(t){return this.fn("keys",t).call(this,e),this},save:function(r,i){var s=r.key||this.uuid();return this.exists(s,function(o){o||(r.key&&delete r.key,e.push(s)),t[s]=r,window.top.name=JSON.stringify(n),i&&(r.key=s,this.lambda(i).call(this,r))}),this},batch:function(e,t){var n=[];for(var r=0,i=e.length;r<i;r++)this.save(e[r],function(e){n.push(e)});return t&&this.lambda(t).call(this,n),this},get:function(e,n){var r;if(this.isArray(e)){r=[];for(var i=0,s=e.length;i<s;i++)r.push(t[e[i]])}else r=t[e],r&&(r.key=e);return n&&this.lambda(n).call(this,r),this},exists:function(e,n){return this.lambda(n).call(this,!!t[e]),this},all:function(n){var r=[];for(var i=0,s=e.length;i<s;i++){var o=t[e[i]];o.key=e[i],r.push(o)}return this.fn(this.name,n).call(this,r),this},remove:function(r,i){var s=this.isArray(r)?r:[r];for(var o=0,u=s.length;o<u;o++)delete t[s[o]],e.splice(this.indexOf(e,s[o]),1);return window.top.name=JSON.stringify(n),i&&this.lambda(i).call(this),this},nuke:function(r){return t={},e=[],window.top.name=JSON.stringify(n),r&&this.lambda(r).call(this),this}}}())}}),define("lawnchair/lawnchair",["./core","./adapters/indexed-db.js","./adapters/dom.js","./adapters/window-name.js"],function(e){for(var t=arguments.length-1;t>0;t--)arguments[t](e);return e}),define("nell",["./alea","./lawnchair/lawnchair"],function(e,t){var n=["n0","n1","n2","n3","n4","n5","n6","n7","n8","n9","n10"],r=e.Random(),i=function(e,t,n,r){e.exists(t,function(i){i?e.get(t,r):r(n)})},s=function(e,t){this.lawnchair=e,t?this.setColor(t):(this.setColor(r.choice(n)),this.saveColor())};s.prototype={},s.prototype.setColor=function(e){document.body.classList.remove(this.color||"n0"),this.color=e,document.body.classList.add(this.color)},s.prototype.saveColor=function(){this.lawnchair.save({key:"color",value:this.color,timestamp:Date.now()},function(){})},s.prototype.switchColor=function(){var e=n.filter(function(e){return e!==this.color}.bind(this));this.setColor(r.choice(e)),this.saveColor(),this.funf&&this.funf.record("colorchange",this.color)};var o=function(e){var n=function(t){i(t,"color",null,function(n){e(new s(t,n&&n.value))})};t({name:"nell"},function(){n(this)})};return{load:function(e,t,n,r){r.isBuild||typeof document=="undefined"?n(null):o(n)}}}),define("score",["./lawnchair/lawnchair"],function(e){var t=function(e,t,n,r){e.exists(t,function(i){i?e.get(t,r):r(n)})},n=function(e,t){this.lawnchair=e,this.unlocked=t||{}};n.prototype={},n.prototype._get=function(e,t,n){if(!this.unlocked[e]){if(!n)return{};this.unlocked[e]={}}if(!this.unlocked[e][t]){if(!n)return{};this.unlocked[e][t]={}}return this.unlocked[e][t]},n.prototype.isCompleted=function(e,t){return!!this._get(e,t).firstCompleted},n.prototype.numStars=function(e,t){return this._get(e,t).numStars||0},n.prototype.setCompleted=function(e,t,n){var r=this._get(e,t,!0),i=r.numStars||0,s=!r.firstCompleted||n>i;if(!s)return;r.firstCompleted||(r.firstCompleted=Date.now()),r.lastCompleted=Date.now(),r.numStars=n,this.funf&&this.funf.record("unlocked",{level:e,altitude:t,numStars:n,firstCompleted:r.firstCompleted}),this.save()},n.prototype.save=function(){this.lawnchair.save({key:"unlocked",value:this.unlocked})};var r=function(r){var i=function(e){t(e,"unlocked",{},function(t){r(new n(e,t.value))})};e({name:"score"},function(){i(this)})};return{load:function(e,t,n,i){i.isBuild||typeof document=="undefined"?n(null):r(n)}}}),define("sound",[],function(){function r(){}function s(e,t){var n=new e({url:t.url,instances:t.instances,callback:t.callback,errback:t.errback})}function o(t){var n=t.url;if(!n)throw"you must pass a URL to Effect.";var s=new i(n,t.formats||[],t.instances||e,t.callback?function(e,t){return function(){t(e)}}(this,t.callback):r,t.errback||r);this.__defineGetter__("audio",function(){return s.getInstance()}),this.__defineGetter__("url",function(){return n}),this.play=function(){var e=this.audio;return e?(e.play(),e):null},this.loop=function(){s.loop()},this.unloop=function(){s.unloop()}}function u(e){e.instances=1,o.call(this,e)}var e=4,t={mp3:"audio/mpeg",ogg:"audio/ogg",wav:"audio/wav",aac:"audio/aac",webm:"audio/webm",m4a:"audio/x-m4a"},n=function(){return"Audio"in window?window.Audio:function(){return document.createElement("audio")}}(),i=function(e,r,i,s,o){var u=new n,a=!1,f=[];u.autobuffer=!0,u.preload="auto",u.addEventListener("error",function(){o(u.error)},!1),u.addEventListener("canplaythrough",function(){if(a)return;while(i--)f.push(u.cloneNode(!0));a=!0,s()},!1);var l=function(e){return e.split(".").pop()},c=function(e){var n=document.createElement("source");n.src=e,t[l(e)]&&(n.type=t[l(e)]),u.appendChild(n)};r&&r.length>0?r.forEach(function(t){c(e+"."+t)}):c(e),this.getInstance=function(){var e,t,n;for(n=0,t=f.length;n<t;n++){e=f[n];if(e.paused||e.ended)return e.ended&&(e.currentTime=0),e}return f.length===0?null:(e=f[0],e.pause(),e.currentTime=0,e)};var h=function(){u.currentTime=0,u.play()};this.loop=function(){u.loop=!0,u.addEventListener("ended",h,!1),u.play()},this.unloop=function(){if(!u.loop)return;u.pause(),u.removeAttribute("loop"),u.removeEventListener("ended",h,!1);try{u.currentTime=0}catch(e){console.log("AUDIO PROBLEM: "+e)}}};return window.cordovaDetect&&(i=function(e,t,n,r,i){var s=[],o=[];e="/android_asset/www/"+e,t&&t.length>0&&(e+="."+t[0]),this.getInstance=function(){var t,r,i;for(i=0,r=s.length;i<r;i++){t=s[i];if(o[i])return t.seekTo(0),o[i]=!1,t}return r<n?(s[r]=t=new Media(e,function(){o[r]=!0}),o[r]=!1,t):s.length===0?null:(t=s[0],t.seekTo(0),t)};var u=null;this.loop=function(){var t;u&&this.unloop();var n=function(){if(u===null||u.id!==t.id)return;t.seekTo(0),t.play()};u=t=new Media(e,n),u.play()},this.unloop=function(){var e=u;u=null,e&&(e.stop(),e.release())},r()}),o.load=function(e){s(o,e)},u.load=function(e){s(u,e)},{Effect:o,Track:u}}),define("version",[],function(){return"7"}),define("index",["domReady!","./alea","./compat","./funf","nell!","score!","sound","./version"],function(e,t,n,r,s,o,u,a){function Ht(){C.record("startColor",s.color),C.record("startVersion",a);var t=function(){var t=e.body,n=t.parentElement.offsetWidth;if(n>=800)t.style.width=t.style.height=t.style.WebkitTransform=t.style.MozTransform=t.style.transform="";else{var r=n/800;t.style.width="800px",t.style.height=100/r+"%";var i="scale("+r+")";t.style.WebkitTransform="translate3d(0,0,0) "+i,t.style.MozTransform=t.style.transform=i}};window.addEventListener("resize",t,!1),t(),window.GameMode=pt,pt.Menu.switchLevel(vt[0]),pt.switchTo(pt.Menu),E&&(history.replaceState(pt.currentMode.toJSON(),f+" | Menu","#menu"),window.addEventListener("popstate",_t,!1));if(window&&window.navigator&&window.navigator.mozApps&&window.navigator.mozApps.getSelf&&window.navigator.mozApps.install){var n=window.navigator.mozApps.getSelf();n.onsuccess=function(){n.result?C.record("installed","yes"):(C.record("installed","no"),pt.Install.doInstall=function(e){var t=window.navigator.mozApps.install("http://nell-balloons.github.cscott.net/manifest.webapp");t.onsuccess=function(){C.record("installed","success"),e(!0)},t.onerror=function(){C.record("installerror",this.error.name),e(!1)}},pt.Install.push())},n.onerror=function(){C.record("installerror",this.error.name),console.log("Error checking installation status: "+this.error.name)}}var r=!1;if(window.cordovaDetect)r=!0;else if(window.navigator){var i=window.navigator.platform.toLowerCase(),o=window.navigator.userAgent.toLowerCase();if(i.indexOf("android")>=0||o.indexOf("android;")>=0||o.indexOf(" android ")>=0||o.indexOf("tablet;")>=0||o.indexOf("fennec")>=0)r=!0}if(r)if(window.matchMedia){var u=window.matchMedia("screen and (orientation: landscape)"),l=function(e){var t=!e.matches;Dt(t)};u.addListener(l),l(u)}else"orientation"in window&&(window.addEventListener("orientationchange",Pt,!1),Pt());e.addEventListener("backbutton",function(){E?history.back():pt.currentMode===pt.Playing&&pt.switchTo(pt.Menu)},!1),e.addEventListener("pause",Ct,!1),e.addEventListener("resume",kt,!1),Ot();var c=window.cordovaDetect&&window.device&&window.device.platform==="Android"&&window.device.name==="tervigon";c||e.body.classList.add("anim")}var f=e.title="Nell's Balloons",l="sounds/barrios_gavota",c=["black","lilac","orange","yellow"],h=.05,p=.8,d=.25,v=1e3,m=h,g=2,y=!1,w=!1,E=history.pushState&&history.replaceState,S=t.Random(),x=e.getElementById("game"),T=e.getElementById("buttons"),N=e.getElementById("balloons"),C=s.funf=o.funf=new r("NellBalloons"+a),k,L,A,O,M=["ground","troposphere","stratosphere","mesosphere"];M.forEach(function(e,t){M[e]=t}),M.toNum=function(e){return M[e]};var _=[["a1",1],["a2",.5],["a3",1/8+1/6],["a4",.1875],["a5",.13125],["a6",1/64+1/12]],D=function(e,t){var n;for(n=0;n<e.length;n++)t(e[n],n)},P=0,H=function(){P=(P+1)%6;var e,t;for(e=0,sum=0;e<_.length;e++){if(!P){t=O[_[e][0]];if(t.size>=0)continue}sum+=_[e][1]}var n=S()*sum;for(e=0,sum=0;e<_.length;e++){if(!P){t=O[_[e][0]];if(t.size>=0)continue}sum+=_[e][1];if(n<sum)return _[e][0]}return _[_.length-1][0]},B=function(){var t;for(t=0;t<_.length;t++){var n=O[_[t][0]];if(n.size>=0){n.shrink();if(n.size<0){var r=e.querySelector("#awards .award."+_[t][0]);r.classList.remove("show")}return}}},j=function(){for(i=0;i<_.length;i++){var e=O[_[i][0]];if(e.size<0)return}if(pt.currentMode!==pt.Playing)return;var t=_.map(function(e){return O[e[0]].size});C.record("mode",{name:"playing",type:"levelcomplete",stars:wt.stars,streak:wt.streak,smoothedHeight:wt.smoothedHeight,sprouts:t,level:pt.Playing.currentLevel.num,altitude:M.toNum(pt.Playing.currentAltitude)}),o.setCompleted(pt.Playing.currentLevel.levelClass,pt.Playing.currentAltitude,wt.stars),it(),ct[0].play(),pt.StarThrob.push()},F=function(e,t){this.domElement=e,this.domElement.classList.add(t),this.color=t};F.prototype={},F.prototype.reset=function(e){this.domElement.classList.remove(this.color),this.domElement.classList.add(e),this.color=e},F.prototype.attach=function(e){e.appendChild(this.domElement)},F.prototype.detach=function(){this.domElement.parentElement.removeChild(this.domElement)};var I=function(t){F.call(this,e.createElement("a"),t),this.domElement.href="#";var n=!!window.cordovaDetect;["mousedown","touchstart"].forEach(function(e){if(n&&e[0]==="m")return;this.domElement.addEventListener(e,this.highlight.bind(this),!1)}.bind(this)),["mouseup","mouseout","touchcancel","touchend"].forEach(function(e){if(n&&e[0]==="m")return;this.domElement.addEventListener(e,this.unhighlight.bind(this),!1)}.bind(this)),this.domElement.addEventListener("click",function(e){e.preventDefault()},!1),this.ignoreMouse=!1};I.prototype=Object.create(F.prototype),I.prototype.highlight=function(e){switch(e.type){case"touchstart":this.ignoreMouse=!0;break;case"mousedown":if(this.ignoreMouse)return}this.domElement.classList.add("hover"),e.preventDefault(),this.fast&&this.ignoreMouse&&this.handleClick()},I.prototype.unhighlight=function(e){switch(e.type){case"mouseup":case"mouseout":if(this.ignoreMouse)return}this.domElement.classList.remove("hover"),e.preventDefault(),e.type!=="touchcancel"&&e.type!=="mouseout"&&(!this.fast||!this.ignoreMouse)&&this.handleClick(),this.ignoreMouse=!1};var q=function(t){I.call(this,t),this.domElement.appendChild(e.createElement("span")),this.attach(T),this.fast=!0};q.prototype=Object.create(I.prototype),q.prototype.handleClick=function(){if(pt.currentMode!==pt.Playing)return;L(this.color)};var R=function(e){I.call(this,"tag"),this.altitude=e};R.prototype=Object.create(I.prototype),R.prototype.handleClick=function(){this.altitudeClicked(this.altitude)};var U=["var1","var2","var3","var4"],z=function(t){t=t||S.choice(k).color,F.call(this,e.createElement("div"),t),this.balloon=e.createElement("div"),this.balloon.classList.add("balloon"),this.payload=e.createElement("div"),this.payload.classList.add("payload"),this.domElement.appendChild(this.payload),this.domElement.appendChild(this.balloon),this.attach(N),this.reset(this.color),this.refresh()};z.prototype=Object.create(F.prototype),z.prototype.doBirth=function(){this.born=!0,this.bornTime=Date.now(),this.pauseTime=0,this.height=this.domElement.offsetHeight,this.maxx=N.offsetWidth-this.domElement.offsetWidth,this.x=Math.floor(S()*this.maxx),this.y=N.offsetHeight,this.fastY=this.y-this.height,this.speedy=(.9+.2*S())*m,this.speedx=(2*S()-1)*this.speedy*d,C.record("born",this.color)},z.prototype.reset=function(e){e=e||S.choice(k).color,e!==this.color&&F.prototype.reset.call(this,e),U.forEach(function(e){this.domElement.classList.remove(e)}.bind(this)),this.domElement.classList.add(S.choice(U)),this.born=!1,this.bornTime=this.pauseTime=0,this.bornTimeout=0,this.popped=this.popDone=!1,["popped","squirt","payload-dropped"].forEach(function(e){this.domElement.classList.remove(e)}.bind(this)),this.award=null,this.x=0,this.y=N.offsetHeight},z.prototype.refresh=function(){if(this.popped)return;var e=Math.round(this.x)+"px,"+Math.round(this.y)+"px";this.domElement.style.WebkitTransform="translate3d("+e+",0)",this.domElement.style.MozTransform=this.domElement.style.transform="translate("+e,0/0},z.prototype.update=function(t){if(!this.born){this.bornTimeout-=t,this.bornTimeout<0&&this.doBirth();return}if(this.popped){this.popTimeout-=t;if(this.popTimeout<0){this.popDone=!0,this.domElement.classList.contains("squirt")&&S.choice(ot).play();if(this.award){var n=e.querySelector("#awards .award."+this.award),r=O[this.award];r.size>=0&&n.classList.add("show"),n.style.WebkitTransform=n.style.MozTransform=n.style.transform="";var i=e.querySelector("#awards .award.flex");i.style.display="none",j()}}return}if(this.y>this.fastY){var s=(this.y-this.fastY)/p;s>t?this.y-=t*p:this.y=this.fastY-(t-s)*this.speedy}else this.y-=t*this.speedy;this.x+=t*this.speedx,this.x<0&&(this.x=0,this.speedx=0),this.x>this.maxx&&(this.x=this.maxx,this.speedx=0)},z.prototype.isGone=function(){return this.born?this.y<-this.height||this.popDone:!1},z.prototype.pop=function(){this.popped=!0;var t=S()<1/3.5;w&&(t=!0);var n=S()<1/15,r=t?lt:n?ut:ot;S.choice(r).play(),this.domElement.classList.add("payload-dropped");if(t){this.domElement.classList.add("popped"),this.popTimeout=250,this.award=H();var i=e.querySelector("#awards .award."+this.award),s=O[this.award];if(s.size>=0){var o=e.querySelector("#awards .award.flex");o.style.top=i.offsetTop+"px",o.style.left=i.offsetLeft+"px",o.style.display="block",o.className="award flex "+this.award,i=o,this.popTimeout=750}var u=i.offsetTop+i.offsetParent.offsetTop,a=i.offsetLeft+i.offsetParent.offsetLeft,f=Math.round(this.x-a+23),l=Math.round(this.y-u+20),c=f+"px,"+l+"px";i.style.WebkitTransform="translate3d("+c+",0)",i.style.MozTransform=i.style.transform="translate("+c+")",s.grow(),$()}else n?(this.domElement.classList.add("squirt"),this.popTimeout=2e3):(this.domElement.classList.add("popped"),this.popTimeout=250)};var W=function(){function n(t){var n;for(n=0;t*n<e.length;n++)e[n]=e[t*n];e.length=n}var e=[[.143,.078]],t=function(t,n){var r,i,s,o=e[e.length-1];for(r=1;r<=t;r++)i=(n[0]-o[0])*r/t,s=(n[1]-o[1])*r/t,e.push([o[0]+i,o[1]+s])};return t(1,[.215,.118]),t(1,[.287,.156]),t(5,[.857,.469]),t(16,[1,1]),n(2),Object.freeze(e),e}(),X=function(t){this.awardClass=t,this.domElement=e.querySelector("#sprouts .award."+t),this.setSize(-1)};X.prototype={},X.prototype.grow=function(){this.setSize(this.size+1)},X.prototype.shrink=function(){this.setSize(this.size-1)},X.prototype.setSize=function(e){var t,n,r;e=Math.max(-1,Math.min(e,W.length-1)),e=Math.round(e);if(this.size===e)return;this.size=e,e<0?(this.domElement.classList.remove("show"),t=n=""):(this.domElement.classList.add("show"),r=W[e],t="scale("+r[0]+","+r[1]+")",n="translate3d(0,0,0) "+t),this.domElement.style.WebkitTransform=n,this.domElement.style.MozTransform=this.domElement.style.transform=t,this.setTime()},X.prototype.setTime=function(e,t){this.domElement.style.webkitTransitionDuration=this.domElement.style.mozTransitionDuration=this.domElement.style.transitionDuration=e||"",this.domElement.style.webkitTransitionDelay=this.domElement.style.mozTransitionDelay=this.domElement.style.transitionDelay=t||""},O={},_.forEach(function(e){O[e[0]]=new X(e[0])}),Object.freeze(O);var V=function(){if(!(o.recent&&o.recent.length>=_.length))return;_.forEach(function(t,n){var r=O[t[0]];r.setSize(o.recent[n]);if(r.size>=0){var i=e.querySelector("#awards .award."+t[0]);i.classList.add("show")}})},$=function(){var e=_.map(function(e){return O[e[0]].size});o.save(e)};k=[];var J=function(){while(k.length>0)b=k.pop(),b.detach();var e=c.slice(0);S.shuffle(e),e.forEach(function(e){var t=new q(e);k.push(t)})};J();var K=function(e){var t=e.changedTouches,n,r;for(n=0;n<t.length;n++){var i=t[n];for(r=0;r<k.length;r++){var s=k[r];if(i.target===s.domElement||i.target===s.domElement.firstChild)e.type==="touchstart"?(s.domElement.classList.add("hover"),s.handleClick()):s.domElement.classList.remove("hover")}}return e.stopPropagation(),e.preventDefault(),!1};["touchstart","touchend","touchcancel"].forEach(function(t){e.getElementById("buttons").addEventListener(t,K,!0)}),altitudeStars=[];var Q=function(){M.forEach(function(t){var n=new R(t);n.attach(e.querySelector("#menu .awards > ."+t)),altitudeStars.push(n)})};Q();var G=[];while(G.length<g)G.push(new z);var Y=null,Z=function(){return null},et=function(){},tt=function(e){e.y<-4?G.forEach(function(e){e.speedx-=50}):e.y>4&&G.forEach(function(e){e.speedx+=50})};navigator.accelerometer&&(Z=function(){return navigator.accelerometer.watchAcceleration(tt,function(){},{frequency:80})},et=function(e){navigator.accelerometer.clearWatch(e)});var nt,rt=function(e){nt&&nt.origSrc!==e&&(it(),nt=null),nt||(nt=new u.Track({url:e,formats:["webm"]}),nt.origSrc=e),nt.loop()},it=function(){nt&&nt.unloop()},st=function(e){return e.map(function(e){return new u.Effect({url:e,instances:2,formats:["webm"]})})},ot=st(["sounds/burst1","sounds/burst2","sounds/burst3","sounds/burst4","sounds/burst5","sounds/burst6","sounds/burst7"]),ut=st(["sounds/deflate1","sounds/deflate2"]),at=st(["sounds/wrong1"]),ft=st(["sounds/wrong2"]),lt=st(["sounds/award"]),ct=st(["sounds/levelwin","sounds/levellose"]),ht=function(e,t,n,r){var i=r?t&&t[r]:t,s=r?n[r]:n;return i&&e.classList.remove(i),e.classList.add(s),n},pt=function(e){this.bodyClass=e,this.active=!1};pt.prototype={},pt.prototype.enter=function(){this.resume(),e.body.classList.add(this.bodyClass),this.active=!0},pt.prototype.leave=function(){this.pause(),e.body.classList.remove(this.bodyClass),this.active=!1},pt.prototype.pause=function(){e.body.classList.add("paused")},pt.prototype.resume=function(){e.body.classList.remove("paused")},pt.prototype.toJSON=function(){return{mode:this.bodyClass}},pt.currentMode=null,pt.switchTo=function(e){pt.currentMode&&pt.currentMode.leave(),pt.currentMode=e,pt.currentMode.enter()},pt.Menu=new pt("menu"),pt.Menu.toJSON=function(){return{mode:"Menu",level:this.currentLevel.num}},pt.Menu.enter=function(e){return function(){e.call(this),C.record("mode",{name:"menu"}),this.syncExposed()}}(pt.Menu.enter),pt.Menu.start=function(e){if(pt.Playing.currentLevel!==this.currentLevel||pt.Playing.currentAltitude!==e)pt.Playing.switchLevel(this.currentLevel),pt.Playing.switchAltitude(e),pt.Playing.reset();E&&history.replaceState(pt.currentMode.toJSON(),f+" | Menu","#menu"),pt.switchTo(pt.Playing),E&&history.pushState(pt.currentMode.toJSON(),f+" | Play!","#play"),C.record("mode",{name:"playing",type:"levelstart",level:pt.Playing.currentLevel.num,altitude:M.toNum(pt.Playing.currentAltitude)})},pt.Menu.switchLevel=function(t){var n=e.querySelector("#menu .level");this.currentLevel=ht(n,this.currentLevel,t,"levelClass");var r=e.querySelector("#menu .levelnav .dot.on");r&&r.classList.remove("on"),t.dot.classList.add("on");var i=e.querySelector("#menu .levelnav .prev");i.classList.remove("hidden"),t.prevLevel||i.classList.add("hidden");var s=e.querySelector("#menu .levelnav .next");s.classList.remove("hidden"),t.nextLevel||s.classList.add("hidden"),this.syncExposed()},pt.Menu.syncExposed=function(){this.setExposed("none",0);if(this.currentLevel.prevLevel&&!o.isCompleted(this.currentLevel.prevLevel.levelClass,M[M.length-1]))return;for(i=0;i<M.length;i++){var e=o.numStars(this.currentLevel.levelClass,M[i]);this.setExposed(M[i],e);if(!o.isCompleted(this.currentLevel.levelClass,M[i]))break}},pt.Menu.setExposed=function(t,n){var r=e.querySelector("#menu .level"),i=this.currentExposed&&"exposed-"+this.currentExposed;ht(r,i,"exposed-"+t),this.currentExposed=t;if(t==="none")return;var s=e.querySelector("#menu .awards > ."+t+" > .stars");["zero","one","two","three"].forEach(function(e,t){n===t?s.classList.add(e):s.classList.remove(e)})},pt.Menu.prevClicked=function(){if(!this.currentLevel.prevLevel)return;this.switchLevel(this.currentLevel.prevLevel)},pt.Menu.nextClicked=function(){if(!this.currentLevel.nextLevel)return;this.switchLevel(this.currentLevel.nextLevel)},["prev","next"].forEach(function(t){var n=new I(t);n.attach(e.querySelector("#menu .levelnav .inner")),n.handleClick=pt.Menu[t+"Clicked"].bind(pt.Menu),pt.Menu[t+"Arrow"]=n}),R.prototype.altitudeClicked=pt.Menu.start.bind(pt.Menu),pt.OverlayMode=function(e){pt.call(this,e),this.underMode=null},pt.OverlayMode.prototype=Object.create(pt.prototype),pt.OverlayMode.prototype.setUnderMode=function(t){this.underMode=this.active?ht(e.body,this.underMode,t,"bodyClass"):t},pt.OverlayMode.prototype.push=function(){this.lastMode=pt.currentMode,this.setUnderMode(pt.currentMode.underMode||pt.currentMode),pt.switchTo(this)},pt.OverlayMode.prototype.pop=function(){console.assert(pt.currentMode===this),pt.switchTo(this.lastMode)},pt.OverlayMode.prototype.enter=function(t){return function(){t.call(this),this.underMode&&e.body.classList.add(this.underMode.bodyClass)}}(pt.OverlayMode.prototype.enter),pt.OverlayMode.prototype.leave=function(t){return function(){t.call(this),this.underMode&&e.body.classList.remove(this.underMode.bodyClass)}}(pt.OverlayMode.prototype.leave),pt.TransitionOverlayMode=function(e,t){pt.OverlayMode.call(this,e),this.delayMs=t,this.switchId=null},pt.TransitionOverlayMode.prototype=Object.create(pt.OverlayMode.prototype),pt.TransitionOverlayMode.prototype.nextMode=function(){},pt.TransitionOverlayMode.prototype.enter=function(e){return function(){e.call(this);var t=window.device&&window.device.platform==="Android",n=this.delayMs;this.switchTime=Date.now()+n,this.switchId=setTimeout(this.switchMode.bind(this),t&&n?250:n)}}(pt.TransitionOverlayMode.prototype.enter),pt.TransitionOverlayMode.prototype.leave=function(e){return function(){e.call(this);if(this.switchId===null)return;clearTimeout(this.switchId),this.switchId=null}}(pt.TransitionOverlayMode.prototype.leave),pt.TransitionOverlayMode.prototype.switchMode=function(){if(Date.now()<this.switchTime){this.switchId=setTimeout(this.switchMode.bind(this),10);return}this.switchId=null,this.nextMode()||this.pop()},pt.StarThrob=new pt.TransitionOverlayMode("starthrob",5e3),pt.StarThrob.enter=function(e){return function(){this.delayMs=wt.stars===0?0:5e3,e.call(this)}}(pt.StarThrob.enter),pt.StarThrob.nextMode=function(){var e=!!window.cordovaDetect;return _.forEach(function(t){var n=O[t[0]];n.size>=0&&(e?n.setSize(-1):(n.setSize(W.length),n.setTime("3s")))}),e&&(pt.SproutsGrow.delayMs=0),pt.SproutsGrow.push(),!0},pt.SproutsGrow=new pt.TransitionOverlayMode("sproutsgrow",3e3),pt.SproutsGrow.nextMode=function(){return pt.Video.push(),!0},pt.Video=new pt.OverlayMode("video"),pt.Video.enter=function(t){return function(){t.call(this),this.maybeUnloadVideo();var n=pt.Playing.currentLevel,r=pt.Playing.currentAltitude,i=e.querySelector("#video > .inner");this.videoElement=e.createElement("video"),this.videoElement.preload="none",this.videoElement.volume=1,this.videoElement.muted=!1,this.videoElement.poster=n.videoFor(r,"jpg"),this.videoElement.addEventListener("canplay",this.canPlay.bind(this),!1),this.videoElement.addEventListener("loadstart",this.canPlay.bind(this),!1),this.videoElement.addEventListener("ended",this.playEnded.bind(this),!1),["webm"].forEach(function(t){var i=e.createElement("source");i.type="video/"+t,i.src=n.videoFor(r,t),this.videoElement.appendChild(i)}.bind(this)),i.insertBefore(this.videoElement,i.firstChild),["loadstart","durationchange","loadedmetadata","loadeddata","progress","canplay","canplaythrough"].forEach(function(e){this.videoElement.addEventListener(e,function(){console.log("GOT "+e+" EVENT!")},!1)}.bind(this)),this.videoElement.load()}}(pt.Video.enter),pt.Video.canPlay=function(){this.videoElement.play(),e.querySelector("#video").classList.add("playing")},pt.Video.playEnded=function(){e.querySelector("#video").classList.remove("playing")},pt.Video.maybeUnloadVideo=function(){this.videoElement&&(this.videoElement.parentElement.removeChild(this.videoElement),this.videoElement=null),e.querySelector("#video").classList.remove("playing")},pt.Video.leave=function(e){return function(){this.maybeUnloadVideo(),e.call(this)}}(pt.Video.leave),pt.Video.arrow=new I("arrow"),pt.Video.arrow.attach(e.querySelector("#video > .inner")),pt.Video.arrow.handleClick=function(){pt.LevelDone.push()},pt.LevelDone=new pt.TransitionOverlayMode("leveldone",0),pt.LevelDone.nextMode=function(){return pt.Playing.nextAltitude()?(pt.Playing.reset(),_.forEach(function(e){var t=O[e[0]];t.setTime("0s","1s")}),pt.switchTo(pt.Playing),!0):E?(this.currentLevel=pt.Playing.currentLevel,history.back(),!0):(pt.Menu.switchLevel(pt.Playing.currentLevel),pt.switchTo(pt.Menu),!0)},pt.Rotate=new pt.OverlayMode("rotate"),pt.Install=new pt.OverlayMode("install"),e.querySelector("#install .yes").addEventListener("click",function(){pt.Install.maybeInstall(!0)},!1),e.querySelector("#install .no").addEventListener("click",function(){pt.Install.maybeInstall(!1)},!1),pt.Install.maybeInstall=function(e){var t=function(){pt.Install.pop()};e?pt.Install.doInstall(t):t()},pt.Playing=new pt("game"),pt.Playing.toJSON=function(){return{mode:"Playing",level:this.currentLevel.num,altitude:this.currentAltitude}},pt.Playing.reset=function(){m=h,G.forEach(function(e,t){e.reset(),e.bornTimeout=1e3+t*v,e.x=N.offsetWidth||-1e3,e.y=N.offsetHeight||-1e3,e.refresh()}),_.forEach(function(e){var t=O[e[0]];t.setSize(-1),t.setTime("0s")}),D(e.querySelectorAll("#awards .award"),function(e){e.classList.remove("show"),e.style.WebkitTransform=e.style.MozTransform=e.style.transform=""});var t=e.querySelector("#awards .award.flex");t.style.display="none",wt.reset()},pt.Playing.switchLevel=function(t){var n=e.querySelector("#gamelevel.level");this.currentLevel=ht(n,this.currentLevel,t,"levelClass")},pt.Playing.switchAltitude=function(t){var n=e.querySelector("#gamelevel.level");this.currentAltitude=ht(n,this.currentAltitude,t)},pt.Playing.nextAltitude=function(){var e=(M.toNum(this.currentAltitude)+1)%M.length;if(e===0){var t=this.currentLevel.nextLevel;if(t===null)return!1;this.switchLevel(t)}return this.switchAltitude(M[e]),!0},pt.Playing.pause=function(e){return function(){e.call(this),this.pauseTime=Date.now(),C.record("status","pause"),it(),A.id!==null&&(n.cancelAnimationFrame(A.id),A.id=null),Y!==null&&(et(),Y=null),$(),C.archive()}}(pt.Playing.pause),pt.Playing.resume=function(e){return function(){e.call(this);var t=this.pauseTime-Date.now();C.record("status","resume"),rt(this.currentLevel.audioUrl()),A.lastFrame=Date.now(),A.id===null&&(A.id=n.requestAnimationFrame(A)),Y===null&&y&&(Y=Z()),G.forEach(function(e){e.pauseTime+=t})}}(pt.Playing.resume),pt.Playing.pauseTime=Date.now();var dt=function(e){this.levelClass=e};dt.prototype={},dt.prototype.audioUrl=function(){var e="sounds/";switch(this.num){default:case 0:e+="barrios_gavota";break;case 1:e+="letting-go";break;case 2:e+="red-wing";break;case 3:e+="arkansas-traveller"}return e},dt.prototype.videoFor=function(e,t){var n="video/SpaceBalloon"+(1+this.num)+"-"+(1+M.toNum(e));return t==="mp4"?n+"-baseline.mp4":t==="jpg"?n+".jpg":n+"-256k32k.webm"};var vt=[new dt("level1"),new dt("level2"),new dt("level3"),new dt("level4")];vt.forEach(function(t,n){t.num=n,t.prevLevel=vt[n-1]||null,t.nextLevel=vt[n+1]||null,t.dot=e.createElement("div"),t.dot.classList.add("dot"),e.querySelector("#menu .levelnav .inner").appendChild(t.dot)});var mt=.8,gt=0,yt=1e4,bt=function(e,t){var n=Math.max(t/.8,.8)*m,r=N.offsetHeight*.9/e,i=(n+r)/2,s=1.2,o=Math.max(m/s,h),u=Math.min(m*s,p);m=Math.max(o,Math.min(u,i))},wt={SMOOTHING:.85,domElement:e.querySelector("#ruler .foreground"),reset:function(){this.smoothedHeight=1,this.height=1,this.stars=0,this.streak=0,D(e.querySelectorAll("#ruler .stars"),function(e){e.classList.remove("highlight")}),this.domElement.style.height="100%"},adjust:function(t,n){var r=pt.Playing.currentAltitude,i;t?(n-=.1,this.streak++):(this.streak=0,n=1),this.smoothedHeight=Math.max(0,Math.min(1,wt.SMOOTHING*this.smoothedHeight+(1-wt.SMOOTHING)*n)),this.height=this.smoothedHeight*Math.max(.28,Math.pow(.98,this.streak));var s=25*(this.height+M.toNum(r));this.domElement.style.height=s+"%";var o=this.height<.28?3:this.height<.54?2:this.height<.79?1:0,u=function(t){return e.querySelector("#ruler ."+r+" .stars."+["zero","one","two","three"][t])};o!==this.stars&&(i=u(this.stars),i&&i.classList.remove("highlight"),this.stars=o,i=u(this.stars),i&&i.classList.add("highlight"))}};wt.reset();var Et=function(e,t,n){C.record("correct",{color:e,time:t}),yt=mt*yt+(1-mt)*t,gt=mt*gt+(1-mt),bt(yt,gt),wt.adjust(!0,n)},St=function(e,t){C.record("incorrect",{type:e,time:t});var n=yt;t>yt&&(n=mt*yt+(1-mt)*t),gt=mt*gt,bt(n,gt),wt.adjust(!1,1)},xt=null,Tt=null,Nt;L=function(e){var t,n,r=null;for(t=0;t<G.length;t++)n=G[t],n.color===e&&n.born&&!n.isGone()&&!n.popped&&(r===null||n.y<r.y)&&(r=n);if(r===null){if(Tt!==null&&e==Nt)return;if(xt!==null)return;S.choice(at).play(),St("click."+e,Math.round(N.offsetHeight/m)),B(),$(),xt=window.setTimeout(function(){xt=null},500)}else r.pop(),Et(e,Date.now()-r.bornTime-r.pauseTime,1-Math.max(0,r.y/N.offsetHeight)),Nt=e,Tt&&window.clearTimeout(Tt),Tt=window.setTimeout(function(){Tt=null},500)};var Ct=function(){pt.currentMode.pause()},kt=function(){pt.currentMode.resume()},Lt="hidden",At="visibilitychange";typeof e.hidden!="undefined"?(Lt="hidden",At="visibilitychange"):typeof e.mozHidden!="undefined"?(Lt="mozHidden",At="mozvisibilitychange"):typeof e.msHidden!="undefined"?(Lt="msHidden",At="msvisibilitychange"):typeof e.webkitHidden!="undefined"&&(Lt="webkitHidden",At="webkitvisibilitychange");var Ot=function(){var t=!0;return function(n){var r=e[Lt]||!1;if(t===r)return;t=r,r?Ct():kt()}}();e.addEventListener(At,Ot,!1),A=function(){A.id=null;var e=Date.now(),t=!1,r=!1,i,s,o=Math.max(0,Math.min(e-A.lastFrame,100));for(i=0;i<G.length;i++)s=G[i],s.update(o),s.isGone()&&(s.popped||(r=!0,St("escape."+s.color,e-s.bornTime-s.pauseTime)),t=!0,s.reset(),e-A.lastBorn<v?(s.bornTimeout=v-(e-A.lastBorn),A.lastBorn+=v):A.lastBorn=e),s.refresh();r&&S.choice(ft).play(),t,A.lastFrame=e,pt.currentMode===pt.Playing&&(A.id=n.requestAnimationFrame(A))},A.id=null,A.lastFrame=Date.now(),A.lastBorn=0;var Mt=function(e){e.type==="touchstart"&&e.target.removeEventListener("mousedown",Mt,!1),e.preventDefault(),s.switchColor()};["mousedown","touchstart"].forEach(function(t){var n=!!window.cordovaDetect;if(n&&t[0]==="m")return;D(e.querySelectorAll(".nells > div > div"),function(e){e.addEventListener(t,Mt,!1)})});var _t=function(e){var t=e.state;if(!t)return;if(!t.mode)return;switch(t.mode){case"Playing":pt.Playing.switchLevel(vt[t.level]),pt.Playing.switchAltitude(vt[t.altitude]),pt.switchTo(pt.Playing);break;case"Menu":pt.currentMode.currentLevel?pt.Menu.switchLevel(pt.currentMode.currentLevel):pt.Menu.switchLevel(vt[t.level]),pt.switchTo(pt.Menu)}},Dt=function(e){e?pt.currentMode===pt.Rotate&&(pt.Rotate.pop(),C.record("orientation","portrait")):pt.currentMode!==pt.Rotate&&(pt.Rotate.push(),C.record("orientation","landscape"))},Pt=function(e){var t=window.device&&window.device.platform==="Android"&&window.device.name==="tervigon";if(!t)return;var n=window.orientation!==0&&window.orientation!==180;e||(n=window.outerHeight>=window.outerWidth),Dt(n)};window.cordovaDetect?e.addEventListener("deviceready",Ht,!1):(console.log("not on phonegap"),Ht())})